name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Generate changelog
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git tag --sort=-creatordate | sed -n '2p')
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          echo "## ðŸŽ‰ What's New in $CURRENT_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "### ðŸš€ Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is the first release of ZenBlock!" >> CHANGELOG.md
          else
            echo "### ðŸ“ Changes since $PREVIOUS_TAG" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # ç”Ÿæˆæäº¤æ—¥å¿—
            git log $PREVIOUS_TAG..$CURRENT_TAG --pretty=format:"- %s (%h)" --no-merges >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸ³ Docker Images" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Docker Hub" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "docker pull malossov/zenblock:$CURRENT_TAG" >> CHANGELOG.md
          echo "docker pull malossov/zenblock:latest" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### GitHub Container Registry" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "docker pull ghcr.io/malossov/zenblock:$CURRENT_TAG" >> CHANGELOG.md
          echo "docker pull ghcr.io/malossov/zenblock:latest" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸš€ Quick Start" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "docker run -d \\" >> CHANGELOG.md
          echo "  --name zenblock \\" >> CHANGELOG.md
          echo "  -p 3000:3000 \\" >> CHANGELOG.md
          echo "  -v ./zenblock-data:/app/data \\" >> CHANGELOG.md
          echo "  malossov/zenblock:$CURRENT_TAG" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸ“¦ Supported Platforms" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- \`linux/amd64\` - x86_64 architecture" >> CHANGELOG.md
          echo "- \`linux/arm64\` - ARM64 architecture (Apple Silicon, Raspberry Pi, etc.)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸ“š Documentation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- [README](https://github.com/MALossov/zenblock/blob/master/README.md)" >> CHANGELOG.md
          echo "- [ä¸­æ–‡æ–‡æ¡£](https://github.com/MALossov/zenblock/blob/master/README.zh.md)" >> CHANGELOG.md
          echo "- [Docker Hub Setup](https://github.com/MALossov/zenblock/blob/master/.github/DOCKER_HUB_SETUP.md)" >> CHANGELOG.md
          
          cat CHANGELOG.md
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
